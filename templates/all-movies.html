{% extends "header.html" %}

{% block title %}Phim - Bee Movie Cinema{% endblock %}

{% block content %}
<main>    

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Tìm kiếm phim...">
        <select id="genreFilter">
            <option value="all">Tất cả thể loại</option>
            <option value="Hành động">Hành động</option>
            <option value="Hài">Hài</option>
            <option value="Tình cảm">Tình cảm</option>
            <option value="Kinh dị">Kinh dị</option>
        </select>
        <button class="btn btn-primary" onclick="renderMovies()">Tìm Kiếm</button>
    </div>

    <div class="container my-4" style="padding: 0 30px;">
        <h2>{{ title }}</h2> 
    </div>
    <div class="movie-grid" id="movieGrid"></div>

    <div class="modal" id="movieModal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <img id="modalImage" src="" alt="">
            <h2 id="modalTitle"></h2>
            <p id="modalGenre"></p>
            <p id="modalDesc"></p>
            <a id="modalBuyTicket" href="#" class="btn-buy" style="width: 100%;">MUA VÉ / XEM CHI TIẾT</a>
        </div>
    </div>

    <footer>
        &copy; 2025 BeeMovies Cinemas. All rights reserved.
    </footer>

    <script>
        const movies = {{ movies_data_from_server | tojson | safe }}; 
        
        const movieGrid = document.getElementById("movieGrid");
        const searchInput = document.getElementById("searchInput");
        const genreFilter = document.getElementById("genreFilter");
        const modal = document.getElementById("movieModal");
        const closeModal = document.getElementById("closeModal");
        const modalImage = document.getElementById("modalImage");
        const modalTitle = document.getElementById("modalTitle");
        const modalGenre = document.getElementById("modalGenre");
        const modalDesc = document.getElementById("modalDesc");
        const modalBuyTicket = document.getElementById("modalBuyTicket");

        function renderMovies() {
            const searchText = searchInput.value.toLowerCase();
            const genre = genreFilter.value;
            movieGrid.innerHTML = "";

            const filtered = movies.filter(m => 
                (genre === "all" || (m.genre && m.genre.toLowerCase().includes(genre.toLowerCase()))) &&
                m.title.toLowerCase().includes(searchText)
            );

            if (filtered.length === 0) {
                movieGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 50px; font-size: 1.2em;">Không tìm thấy phim nào phù hợp.</p>`;
                return;
            }

            filtered.forEach(m => {
                const card = document.createElement("div");
                card.classList.add("movie-card");
                
                const imgSrc = m.img || m.poster_url || "https://via.placeholder.com/250x350/333333/FFFFFF?text=Không+có+Poster";

                card.innerHTML = `
                    <img src="${imgSrc}" alt="${m.title}" 
                         onerror="this.onerror=null;this.src='https://via.placeholder.com/250x350/333333/FFFFFF?text=Không+có+Poster'">
                    <div class="movie-info">
                        <h3>${m.title}</h3>
                        <p>${m.genre || ''}</p>
                    </div>
                `;
                
                card.addEventListener("click", () => openModal(m));
                movieGrid.appendChild(card);
            });
        }

        function openModal(movie) {
            const imgSrc = movie.img || movie.poster_url || "https://via.placeholder.com/600x350/333333/FFFFFF?text=Không+có+Poster";
            modalImage.src = imgSrc;
            modalTitle.textContent = movie.title;
            modalGenre.textContent = "Thể loại: " + (movie.genre || "");
            modalDesc.textContent = movie.desc || "";
            modalBuyTicket.href = `/movie/${movie.id}`;
            modal.style.display = "flex";
        }

        closeModal.addEventListener("click", () => modal.style.display = "none");
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
        searchInput.addEventListener("input", renderMovies);
        genreFilter.addEventListener("change", renderMovies);

        renderMovies();
    </script>
</main>
{% endblock %}
