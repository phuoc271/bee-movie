{% extends "header.html" %}

{% block title %}Phim - Bee Movie Cinema{% endblock %}

{% block content %}
<main>    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Tìm kiếm phim...">
        <select id="genreFilter">
            <option value="all">Tất cả thể loại</option>
            <option value="Hành động">Hành động</option>
            <option value="Hài">Hài</option>
            <option value="Tình cảm">Tình cảm</option>
            <option value="Kinh dị">Kinh dị</option>
            </select>
        <button class="btn btn-primary" onclick="renderMovies()">Tìm Kiếm</button>
    </div>

    <main>
        <div class="container my-4" style="padding: 0 30px;">
            <h2>{{ title }}</h2> 
        </div>
        <div class="movie-grid" id="movieGrid"></div>
    </main>

    <div class="modal" id="movieModal">
        <div class="modal-content">
            <span class="close-btn" id="closeModal">&times;</span>
            <img id="modalImage" src="" alt="">
            <h2 id="modalTitle"></h2>
            <p id="modalGenre"></p>
            <p id="modalDesc"></p>
            <a id="modalBuyTicket" href="#" class="btn-buy" style="width: 100%;">MUA VÉ / XEM CHI TIẾT</a>
        </div>
    </div>

    <footer>
        &copy; 2025 BeeMovies Cinemas. All rights reserved.
    </footer>

    <script>
        const movies = {{ movies_data_from_server | tojson | safe }}; 
        
        const movieGrid = document.getElementById("movieGrid");
        const searchInput = document.getElementById("searchInput");
        const genreFilter = document.getElementById("genreFilter");
        const modal = document.getElementById("movieModal");
        const closeModal = document.getElementById("closeModal");
        const modalImage = document.getElementById("modalImage");
        const modalTitle = document.getElementById("modalTitle");
        const modalGenre = document.getElementById("modalGenre");
        const modalDesc = document.getElementById("modalDesc");
        const modalBuyTicket = document.getElementById("modalBuyTicket");

        function renderMovies() {
            const searchText = searchInput.value.toLowerCase();
            const genre = genreFilter.value;
            movieGrid.innerHTML = "";

            const filtered = movies.filter(m => 
                // Lọc theo thể loại: kiểm tra xem giá trị trong select (genre) có nằm trong chuỗi thể loại (m.genre) không
                // Ví dụ: kiểm tra "Hành động" có trong "Hành động / Hài" không.
                (genre === "all" || m.genre.toLowerCase().includes(genre.toLowerCase())) &&
                // Lọc theo tên phim
                m.title.toLowerCase().includes(searchText)
            );

            if (filtered.length === 0) {
                movieGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; padding: 50px; font-size: 1.2em;">Không tìm thấy phim nào phù hợp.</p>`;
                return;
            }

            filtered.forEach(m => {
                const card = document.createElement("div");
                card.classList.add("movie-card");
                
                // Sử dụng dữ liệu động từ TMDB
                card.innerHTML = `
                    <img src="${m.img}" alt="${m.title}">
                    <div class="movie-info">
                        <h3>${m.title}</h3>
                        <p>${m.genre}</p>
                    </div>
                `;
                
                // Thêm Event Listener để mở Modal
                card.addEventListener("click", () => openModal(m));
                movieGrid.appendChild(card);
            });
        }

        function openModal(movie) {
            modalImage.src = movie.img;
            modalTitle.textContent = movie.title;
            modalGenre.textContent = "Thể loại: " + movie.genre;
            modalDesc.textContent = movie.desc;
            
            // Link MUA VÉ sẽ trỏ đến trang chi tiết phim sử dụng ID phim.
            modalBuyTicket.href = `/movie/${movie.id}`; 
            
            modal.style.display = "flex";
        }

        // Event listeners
        closeModal.addEventListener("click", () => modal.style.display = "none");
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });
        searchInput.addEventListener("input", renderMovies);
        genreFilter.addEventListener("change", renderMovies);

        // Khởi tạo hiển thị phim
        renderMovies();
    </script>
</main>
{% endblock %}